<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <title>Teacher Dashboard | STEMSphere Academy</title>
Â Â 
Â  <link rel="icon" type="image/png" sizes="32x32" href="https://learn.stemsphere.academy/assets/favconsp1.2.png">
Â  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
Â  <style>
Â  Â  * { box-sizing: border-box; margin: 0; padding: 0; }
Â  Â  body {
Â  Â  Â  font-family: 'Segoe UI', sans-serif;
Â  Â  Â  background: #f5f5f5;
Â  Â  Â  color: #000;
Â  Â  Â  min-height: 100vh;
Â  Â  }
Â  Â Â 
Â  Â  header {
Â  Â  Â  background: #fff;
Â  Â  Â  padding: 1rem 2rem;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  align-items: center;
Â  Â  Â  border-bottom: 3px solid #007bff;
Â  Â  Â  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
Â  Â  }
Â  Â  .brand {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 0.5rem;
Â  Â  }
Â  Â  .brand img {
Â  Â  Â  width: 40px;
Â  Â  Â  height: 40px;
Â  Â  }
Â  Â  .brand-text {
Â  Â  Â  font-size: 1.2em;
Â  Â  Â  font-weight: 700;
Â  Â  Â  color: #000;
Â  Â  }
Â  Â  .teacher-badge {
Â  Â  Â  background: #007bff;
Â  Â  Â  color: #fff;
Â  Â  Â  padding: 0.3rem 0.8rem;
Â  Â  Â  border-radius: 20px;
Â  Â  Â  font-size: 0.8em;
Â  Â  Â  font-weight: 600;
Â  Â  Â  margin-left: 0.5rem;
Â  Â  }
Â  Â  .logout-btn {
Â  Â  Â  background: #007bff;
Â  Â  Â  color: #fff;
Â  Â  Â  border: none;
Â  Â  Â  padding: 0.6rem 1.2rem;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-weight: 600;
Â  Â  }

Â  Â  .teacher-container {
Â  Â  Â  max-width: 1400px;
Â  Â  Â  margin: 2rem auto;
Â  Â  Â  padding: 0 1rem;
Â  Â  }

Â  Â  .welcome-section {
Â  Â  Â  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
Â  Â  Â  color: #fff;
Â  Â  Â  padding: 2rem;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  margin-bottom: 2rem;
Â  Â  Â  box-shadow: 0 4px 20px rgba(0,123,255,0.3);
Â  Â  }
Â  Â  .welcome-section h1 {
Â  Â  Â  margin: 0 0 0.5rem 0;
Â  Â  Â  font-size: 2em;
Â  Â  }
Â  Â  .welcome-section p {
Â  Â  Â  margin: 0;
Â  Â  Â  opacity: 0.9;
Â  Â  }

Â  Â  .stats-grid {
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
Â  Â  Â  gap: 1rem;
Â  Â  Â  margin-bottom: 2rem;
Â  Â  }
Â  Â  .stat-card {
Â  Â  Â  background: #fff;
Â  Â  Â  padding: 1.5rem;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  border-left: 4px solid #007bff;
Â  Â  Â  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
Â  Â  }
Â  Â  .stat-card h3 {
Â  Â  Â  font-size: 0.9em;
Â  Â  Â  color: #666;
Â  Â  Â  margin-bottom: 0.5rem;
Â  Â  }
Â  Â  .stat-card .number {
Â  Â  Â  font-size: 2em;
Â  Â  Â  font-weight: 700;
Â  Â  Â  color: #007bff;
Â  Â  }

Â  Â  .tabs {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 0.5rem;
Â  Â  Â  margin-bottom: 2rem;
Â  Â  Â  border-bottom: 2px solid #ddd;
Â  Â  Â  flex-wrap: wrap;
Â  Â  }
Â  Â  .tab {
Â  Â  Â  padding: 1rem 2rem;
Â  Â  Â  background: none;
Â  Â  Â  border: none;
Â  Â  Â  border-bottom: 3px solid transparent;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-weight: 600;
Â  Â  Â  font-size: 1em;
Â  Â  Â  color: #666;
Â  Â  Â  position: relative;
Â  Â  }
Â  Â  .tab.active {
Â  Â  Â  color: #007bff;
Â  Â  Â  border-bottom-color: #007bff;
Â  Â  }
Â  Â  .tab .badge {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 0.5rem;
Â  Â  Â  right: 0.5rem;
Â  Â  Â  background: #ff0000;
Â  Â  Â  color: #fff;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  width: 20px;
Â  Â  Â  height: 20px;
Â  Â  Â  font-size: 0.7em;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  font-weight: 700;
Â  Â  }

Â  Â  .tab-content {
Â  Â  Â  display: none;
Â  Â  }
Â  Â  .tab-content.active {
Â  Â  Â  display: block;
Â  Â  }

Â  Â  .data-table {
Â  Â  Â  background: #fff;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  overflow-x: auto;
Â  Â  Â  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
Â  Â  }
Â  Â  table {
Â  Â  Â  width: 100%;
Â  Â  Â  border-collapse: collapse;
Â  Â  Â  min-width: 800px;
Â  Â  }
Â  Â  th {
Â  Â  Â  background: #f8f8f8;
Â  Â  Â  padding: 1rem;
Â  Â  Â  text-align: left;
Â  Â  Â  font-weight: 600;
Â  Â  Â  border-bottom: 2px solid #ddd;
Â  Â  }
Â  Â  td {
Â  Â  Â  padding: 1rem;
Â  Â  Â  border-bottom: 1px solid #eee;
Â  Â  }

Â  Â  .btn-small {
Â  Â  Â  padding: 0.4rem 0.8rem;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  border: none;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-size: 0.85em;
Â  Â  Â  font-weight: 600;
Â  Â  Â  margin: 0.2rem;
Â  Â  Â  text-decoration: none;
Â  Â  Â  display: inline-block;
Â  Â  }
Â  Â  .btn-complete {
Â  Â  Â  background: #28a745;
Â  Â  Â  color: #fff;
Â  Â  }
Â  Â  .btn-view {
Â  Â  Â  background: #007bff;
Â  Â  Â  color: #fff;
Â  Â  }
Â  Â  .btn-video {
Â  Â  Â  background: #17a2b8;
Â  Â  Â  color: #fff;
Â  Â  }
Â  Â  .btn-create-room {
Â  Â  Â  background: #ffc107;
Â  Â  Â  color: #000;
Â  Â  }
Â  Â  .btn-create-session {
Â  Â  Â  background: #28a745;
Â  Â  Â  color: #fff;
Â  Â  Â  padding: 0.75rem 1.5rem;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-weight: 600;
Â  Â  Â  font-size: 1em;
Â  Â  Â  border: none;
Â  Â  }

Â  Â  .status-badge {
Â  Â  Â  padding: 0.3rem 0.8rem;
Â  Â  Â  border-radius: 20px;
Â  Â  Â  font-size: 0.85em;
Â  Â  Â  font-weight: 600;
Â  Â  }
Â  Â  .status-scheduled {
Â  Â  Â  background: rgba(0,200,0,0.2);
Â  Â  Â  color: #008800;
Â  Â  }
Â  Â  .status-completed {
Â  Â  Â  background: rgba(128,128,128,0.2);
Â  Â  Â  color: #666;
Â  Â  }
    Â  Â  .status-cancelled {
Â  Â  Â  background: rgba(128,128,128,0.2);
Â  Â  Â  color: #666;
Â  Â  }

Â  Â  .loading {
Â  Â  Â  text-align: center;
Â  Â  Â  padding: 3rem;
Â  Â  Â  color: #666;
Â  Â  }
Â  Â  .empty-state {
Â  Â  Â  text-align: center;
Â  Â  Â  padding: 3rem;
Â  Â  Â  color: #999;
Â  Â  }

Â  Â  .info-box {
Â  Â  Â  background: #e7f3ff;
Â  Â  Â  border-left: 4px solid #007bff;
Â  Â  Â  padding: 1rem;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  margin-bottom: 2rem;
Â  _B, B, B, 1
Â  }
Â  Â  .info-box p {
Â  Â  Â  margin: 0;
Â  Â  Â  color: #004085;
Â  Â  }

Â  Â  .inbox-container {
Â  Â  Â  background: #fff;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  padding: 2rem;
Â  Â  Â  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
Â  Â  }
Â  Â  .inbox-header {
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  align-items: center;
Â  Â  Â  margin-bottom: 1.5rem;
Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  gap: 1rem;
Â  Â  }
Â  Â  .inbox-header h3 {
Â  Â  Â  color: #000;
Â  Â  Â  font-size: 1.5em;
Â  Â  }
Â  Â  .compose-btn {
Â  Â  Â  background: #007bff;
Â  Â  Â  color: #fff;
Â  Â  Â  border: none;
Â  Â  Â  padding: 0.75rem 1.5rem;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-weight: 600;
Â  Â  }
Â  Â Â 
Â  Â  .thread-list {
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  gap: 1rem;
Â  Â  }
Â  Â  .thread-item {
Â  Â  Â  border: 2px solid #ddd;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  padding: 1.5rem;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: all 0.3s;
Â  Â  Â  background: #fff;
Â  Â  }
Â  Â  .thread-item:hover {
Â  Â  Â  border-color: #007bff;
Â  Â  Â  box-shadow: 0 2px 8px rgba(0,123,255,0.2);
Â  Â  }
Â  Â  .thread-item.unread {
Â  Â  Â  background: #e3f2fd;
Â  Â  Â  border-color: #007bff;
Â  Â  Â  border-width: 3px;
Â  Â  }
Â  Â  .thread-header {
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  align-items: center;
Â  Â  Â  margin-bottom: 0.75rem;
Â  Â  }
Â  Â  .student-name {
Â  Â  Â  font-weight: 700;
Â  Â  Â  color: #000;
Â  Â  Â  font-size: 1.1em;
Â  Â  }
Â  Â  .thread-meta {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 1rem;
Â  Â  Â  align-items: center;
Â  Â  }
Â  Â  .message-count {
Â  Â  Â  background: #007bff;
Â  Â  Â  color: #fff;
Â  Â  Â  padding: 0.25rem 0.75rem;
Â  Â  Â  border-radius: 20px;
Â  Â  Â  font-size: 0.85em;
Â  Â  Â  font-weight: 600;
Â  Â  }
Â  Â  .unread-count {
Â  Â  Â  background: #ff0000;
Â  Â  Â  color: #fff;
Â  Â  Â  padding: 0.25rem 0.75rem;
Â  Â  Â  border-radius: 20px;
Â  Â  Â  font-size: 0.85em;
Â  Â  Â  font-weight: 600;
Â  Â  Â  animation: pulse-badge 1.5s infinite;
Â  Â  }
Â  Â  @keyframes pulse-badge {
Â  Â  Â  0%, 100% { transform: scale(1); }
Â  Â  Â  50% { transform: scale(1.1); }
Â  Â  }
Â  Â  .last-message-date {
Â  Â  Â  color: #999;
Â  Â  Â  font-size: 0.9em;
Â  Â  }
Â  Â  .last-message-preview {
Â  Â  Â  color: #666;
Â  Â  Â  font-size: 0.95em;
Â  Â  Â  overflow: hidden;
Â  Â  Â  text-overflow: ellipsis;
Â  Â  Â  white-space: nowrap;
Â  Â  Â  margin-top: 0.5rem;
Â  Â  }

Â  Â  .conversation-header {
Â  Â  Â  background: linear-gradient(135deg, #007bff, #0056b3);
Â  Â  Â  color: #fff;
Â  Â  Â  padding: 1.5rem;
Â  Â  Â  border-radius: 8px 8px 0 0;
Â  Â  Â  margin: -2rem -2rem 1.5rem -2rem;
Â  Â  }
Â  Â  .conversation-header h4 {
Â  Â  Â  margin: 0 0 0.5rem 0;
Â  Â  Â  font-size: 1.3em;
Â  Â  }
Â  Â  .conversation-header p {
Â  Â  Â  margin: 0;
Â  Â  Â  opacity: 0.9;
Â  Â  Â  font-size: 0.9em;
Â  Â  }

Â  Â  .message-bubble {
Â  Â  Â  background: #f8f9fa;
Â  Â  Â  border: 1px solid #ddd;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  padding: 1rem;
Â  Â  Â  margin-bottom: 1rem;
Â  Â  }
Â  Â  .message-bubble.from-me {
Â  Â  Â  background: #e3f2fd;
Â  Â  Â  border-color: #007bff;
Â  Â  Â  margin-left: 2rem;
Â  Â  }
Â  Â  .message-bubble.from-student,
Â  Â  .message-bubble.from-support {
Â  Â  Â  margin-right: 2rem;
Â  Â  }
Â  Â  .message-bubble .sender {
Â  Â  Â  font-weight: 600;
Â  Â  Â  color: #007bff;
Â  Â  Â  margin-bottom: 0.5rem;
Â  Â  }
Â  Â  .message-bubble .timestamp {
Â  Â  Â  color: #999;
Â  Â  Â  font-size: 0.85em;
Â  Â  Â  margin-bottom: 0.5rem;
Â  Â  }
Â  Â  .message-bubble .subject {
Â  Â  Â  font-weight: 600;
Â  Â  Â  color: #333;
Â  Â  Â  margin-bottom: 0.5rem;
Â  Â  }
Â  Â  .message-bubble .body {
Â  Â  Â  color: #333;
Â  Â  Â  white-space: pre-wrap;
Â  Â  }

Â  Â  .reply-box {
Â  Â  Â  background: #f8f9fa;
Â  Â  Â  border: 2px solid #007bff;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  padding: 1.5rem;
Â  Â  Â  margin-top: 1.5rem;
Â  Â  }
Â  Â  .reply-box h5 {
Â  Â  Â  margin: 0 0 1rem 0;
Â  Â  Â  color: #007bff;
Â  Â  }

Â  Â  .modal {
Â  Â  Â  display: none;
Â  Â  Â  position: fixed;
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  width: 100vw;
Â  Â  Â  height: 100vh;
Â  Â  Â  background: rgba(0,0,0,0.5);
Â  Â  Â  z-index: 1000;
Â  Â  Â  overflow: auto;
Â  Â  }
Â  Â  .modal.active {
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  Â  padding: 1rem;
Â  Â  }
Â  Â  .modal-content {
Â  Â  Â  background: #fff;
Â  Â  Â  padding: 2rem;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  max-width: 900px;
Â  Â  Â  width: 90%;
Â  Â  Â  max-height: 85vh;
Â  Â  Â  overflow-y: auto;
Â  Â  }
Â  Â  .modal-content h3 {
Â  Â  Â  margin-bottom: 1rem;
Â  Â  Â  color: #007bff;
Â  Â  }
Â  Â  .form-group {
Â  Â  Â  margin-bottom: 1rem;
Â  Â  }
Â  Â  .form-group label {
Â  Â  Â  display: block;
Â  Â  Â  margin-bottom: 0.5rem;
Â  Â  Â  font-weight: 600;
Â  Â  Â  color: #333;
Â  Â  }
Â  Â  .form-group input,
Â  Â  .form-group textarea,
Â  Â  .form-group select {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 0.75rem;
Â  Â  Â  border: 2px solid #ddd;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  font-size: 1em;
Â  Â  Â  font-family: inherit;
Â  Â  }
Â  Â  .form-group textarea {
Â  Â  Â  resize: vertical;
Â  Â  Â  min-height: 150px;
Â  Â  }
Â  Â  .btn-primary {
Â  Â  Â  background: #007bff;
Â  Â  Â  color: #fff;
Â  Â  Â  padding: 0.75rem 1.5rem;
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-weight: 600;
Â  Â  Â  font-size: 1em;
Â  Â  }
Â  Â  .btn-secondary {
Â  Â  Â  background: #6c757d;
Â  Â  Â  color: #fff;
Â  Â  Â  padding: 0.75rem 1.5rem;
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 6px;
Â  S Â  Â  cursor: pointer;
Â  Â  Â  font-weight: 600;
Â  Â  Â  font-size: 1em;
Â  Â  Â  margin-left: 0.5rem;
Â  Â  }

Â  Â  .student-select-grid {
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
Â  Â  Â  gap: 1rem;
Â  Â  Â  margin-top: 1rem;
Â  Â  Â  max-height: 400px;
Â  Â  Â  overflow-y: auto;
Â  Â  Â  padding: 0.5rem;
Â  Â  Â  border: 1px solid #ddd;
Â  Â  Â  border-radius: 6px;
Â  Â  }
Â  Â  .student-card {
Â  Â  Â  border: 2px solid #ddd;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  padding: 1rem;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: all 0.3s;
Â  Â  }
Â  Â  .student-card:hover {
Â  Â  Â  border-color: #007bff;
Â  Â  Â  background: #e3f2fd;
Â  Â  }
F Â  Â  .student-card.selected {
Â  Â  Â  border-color: #007bff;
Â  Â  Â  background: #d4edda;
Â  Â  }
Â  Â  .student-card h4 {
Â  Â  Â  margin: 0 0 0.5rem 0;
Â  Â  Â  color: #000;
Â  Â  }
Â  Â  .student-card p {
Â  Â  Â  margin: 0.25rem 0;
Â  Â  Â  color: #666;
NET-8, 1, 8, 11
Â  Â  Â  font-size: 0.9em;
Â  Â  }

Â  Â  .time-slots {
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: repeat(3, 1fr);
Â  Â  Â  gap: 0.5rem;
Â  Â  Â  margin-top: 1rem;
Â  Â  Â  max-height: 400px;
Â  Â  Â  overflow-y: auto;
Â  Â  Â  padding: 0.5rem;
Â  Â  }
Â  Â  .time-slot {
Â  Â  Â  padding: 0.75rem;
Â  Â  Â  border: 1px solid #ddd;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  text-align: center;
Â  Â  Â  transition: all 0.3s;
Â  Â  }
Â  Â  .time-slot:hover {
Â  Â  Â  background: #e3f2fd;
Â  Â  Â  border-color: #007bff;
Â  Â  }
Â  Â  .time-slot.selected {
Â  Â  Â  background: #007bff;
Â  Â  Â  color: #fff;
Â  Â  Â  border-color: #007bff;
Â  Â  }

Â  Â  .wizard-modal {
Â  Â  Â  display: none;
Â  Â  Â  position: fixed;
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  width: 100vw;
Â  t Â  Â  height: 100vh;
Â  Â  Â  background: #ffffff;
Â  Â  Â  z-index: 2000;
Â  Â  Â  overflow: auto;
Â  Â  }
Â  Â  .wizard-modal.active {
Â  Â  Â  display: block;
Â  Â  }

Â  Â  #wizardProgressBar {
Â  Â  Â  height: 10px;
Â  Â  Â  background: #e0e0e0;
Â  Â  Â  border-radius: 5px;
Â  Â  Â  margin: 20px;
Â  Â  Â  overflow: hidden;
Â  Â  }
Â  Â  #wizardProgressFill {
Â  Â  Â  height: 100%;
Â  Â  Â  width: 0%;
Â  Â  Â  background: linear-gradient(90deg, #007bff, #00c6ff);
Â  Â  Â  border-radius: 5px;
Â  Â  Â  transition: width 0.4s ease;
Â  Â  }

Â  Â  @media (max-width: 768px) {
Â  Â  Â  .time-slots {
Â  Â  Methods: Â  Â  grid-template-columns: repeat(2, 1fr);
Â  Â  Â  }
Â  Â  Â  .student-select-grid {
Â  Â  Â  Â  grid-template-columns: 1fr;
Type: Â  Â  Â  }
Â  Â  Â  .message-bubble.from-me {
Â  Â  Â  Â  margin-left: 0.5rem;
Â  Â  Â  }
Â  Â  Â  .message-bubble.from-student,
Â  Â  Â  .message-bubble.from-support {
Â  Â  Â  Â  margin-right: 0.5rem;
Â  Â  Â  }
Â  Â  }
Â  </style>
</head>
<body>
Â  <header>
Â  Â  <div class="brand">
Â  Â  Â  <img src="https://learn.stemsphere.academy/assets/favconsp1.2.png" alt="STEMSphere Academy">
Â  Â  Â  <span class="brand-text">STEMSphere Academy</span>
Â  Â  Â  <span class="teacher-badge">TEACHER</span>
Â  Â  </div>
Â  Â  <button class="logout-btn" onclick="logout()">Logout</button>
Â  </header>

Â  <div class="teacher-container">
Â  Â  <div class="welcome-section">
Â  Â  Â  <h1>Welcome, <span id="teacherName">Teacher</span>! ğŸ‘¨â€ğŸ«</h1>
Â  Â  Â  <p>Manage your students and upcoming sessions</p>
Â  Â  </div>

Â  Â  <div class="stats-grid">
Â  Â  Â  <div class="stat-card">
Â  Â  Â  Â  <h3>My Students</h3>
Â  Â  Â  Â  <div class="number" id="totalStudents">-</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="stat-card">
Â  Â  Â  Â  <h3>Upcoming Sessions</h3>
Â  Â  Â  Â  <div class="number" id="upcomingSessions">-</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="stat-card">
Â  Â  Â  Â  <h3>Completed Sessions</h3>
Â  Â  Â  Â  <div class="number" id="completedSessions">-</div>
source. 
Â  Â  Â  </div>
Â  Â  Â  <div class="stat-card">
Â  Â  Â  Â  <h3>Unread Messages</h3>
Â  Â  Â  Â  <div class="number" id="unreadMessages">-</div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="tabs">
Â  Â  Â  <button class="tab active" onclick="showTab('upcoming')">ğŸ“… Upcoming Sessions</button>
Â  Â  Â  <button class="tab" onclick="showTab('completed')">âœ… Completed Sessions</button>
Â  Â  Â  <button class="tab" onclick="showTab('students')">ğŸ‘¥ My Students</button>
Â  Â  Â  <button class="tab" onclick="showTab('inbox')">
Â  Â  Â  Â  Â  Â  Â  ğŸ“¬ Inbox
Â  Â  Â  Â  <span class="badge" id="inboxBadge" style="display:none;">0</span>
Â  Â  Â  </button>
Â  Â  Â  <button class="tab" onclick="showTab('support')">
Â  Â  Â  Â  ğŸ†˜ Support
Â  Â  Â  Â  <span class="badge" id="supportBadge" style="display:none;">0</span>
Â  Â  Â  </button>
Â  Â  </div>

Â  Â  Â  Â  <div id="upcomingTab" class="tab-content active">
Â  Â  Â  <div class="info-box">
Â  Â  Â  Â  <p>ğŸ“… Your scheduled upcoming sessions with students.</p>
Â  Â  Â  </div>
Â  Â  Â  <div style="margin-bottom: 1.5rem;">
Â  Â  Â  Â  <button class="btn-create-session" onclick="openCreateSessionWizard()">â• Create New Session</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="data-table">
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  <thead>
Â  Â  s Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  <th>Student Details</th>
Â  Â  Â  Â  Â  Â  Â  <th>Subject & Style</th>
Â  Â  Â  Â  Â  Â  Â  <th>Date</th>
Â  Â  Â  Â  Â  Â  Â  <th>Time</th>
Â  Â  Â  Â  Â  Â  Â  <th>Notes</th>
Â  Â  Â  Â  Â  Â  Â  <th>Actions</th>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  <tbody id="upcomingSessionsBody">
Â  Â  Â  Â  Â  Â  <tr><td colspan="6" class="loading">Loading sessions...</td></tr>
Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div id="completedTab" class="tab-content">
Â  Â  Â  <div class="info-box">
Â  Â  Â  Â  <p>âœ… Sessions you've already completed with your students.</p>
Â  Â  Â  </div>
Â  Â  Â  <div class="data-table">
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  <th>Student Details</th>
Â  Â  Â  Â  Â  Â  Â  <th>Subject & Style</th>
Â  Â  Â  Â  Â  Â  Â  <th>Date</th>
Â  Â  Â  Â  Â  Â  Â  <th>Time</th>
Â  Â  Â  Â  Â  _B, B, B, 1
Â  Â  Â  Â  <th>Notes</th>
Â  Â  Â  Â  Â  Â  Â  <th>Status</th>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  <tbody id="completedSessionsBody">
Â  Â  Â  Â  Â  Â  <tr><td colspan="6" class="loading">Loading completed sessions...</td></tr>
Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div id="studentsTab" class="tab-content">
Â  Â  Â  <div class="info-box">
Â  Â  Â  Â  <p>ğŸ‘¥ These are the students assigned to you by the admin.</p>
Â  Â  Â  </div>
Â  Â  Â  <div class="data-table">
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  <th>Name</th>
Â  Â  Â  Â  Â  Â  Â  <th>Email</th>
Â  Â  Â  Â  Â  Â  Â  <th>Phone</th>
Â  Â  Â  Â  Â  Â  Â  <th>Age Group</th>
Â  Â  Â  Â  Â  Â  Â  <th>Total Sessions</th>
Â  Â  Â  Â  Â  Â  Â  <th>Actions</th>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  <tbody id="studentsBody">
Â  Â  Â  Â  Â  Â  <tr><td colspan="6" class="loading">Loading students...</td></tr>
Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div id="inboxTab" class="tab-content">
Â  Â  Â  <div class="inbox-container">
Â  Â  Â  Â  <div class="inbox-header">
Â  Â  Â  Â  Â  <h3>ğŸ“¬ Student Messages</h3>
Â  Â  Â  Â  Â  <button class="compose-btn" onclick="openComposeToStudentModal()">âœ‰ï¸ Message a Student</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="inboxThreads" class="thread-list">
Â  Â  Â  Â  Â  <div class="empty-state">Loading messages...</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div id="supportTab" class="tab-content">
Â  Â  Â  <div class="inbox-container">
Â  Â  Â  Â  <div class="inbox-header">
Â  Â  Â  Â  Â  <h3>ğŸ†˜ Contact Support</h3>
Â  Â  Â  Â  Â  <button class="compose-btn" onclick="openTeacherSupportModal()">âœ‰ï¸ New Support Ticket</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="teacherSupportMessages" class="thread-list">
Â  Â  Â  Â  Â  <div class="empty-state">Loading support messages...</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  Â  <div id="sessionWizard" class="wizard-modal">
Â  Â  <button onclick="closeSessionWizard()"
Â  Â  Â  style="position:absolute; top:15px; left:20px; font-size:28px; background:none; border:none; color:#000; cursor:pointer; z-index:2001;">âœ–</button>
Â  Â Â 
Â  Â  <div id="wizardProgressBar">
Â  Â  Â  <div id="wizardProgressFill"></div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="wizardContent" style="margin-top:20px;"></div>
Â  </div>

Â  Â  <div id="conversationModal" class="modal">
Â  Â  <div class="modal-content" id="conversationContent">
Â  Â  Â  Â  Â  </div>
Â  </div>

Â  Â  <div id="supportConversationModal" class="modal">
Â  Â  <div class="modal-content" id="supportConversationContent">
Â  Â  Â  Â  Â  </div>
Â  </div>

Â  Â  <div id="composeToStudentModal" class="modal">
Â  Â  <div class="modal-content">
Â  Â  Â  <h3>âœ‰ï¸ Message a Student</h3>
Â  Â  Â Â 
Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  <label>Select Student *</label>
Â  Â  Â  Â  <select id="composeStudentSelect" style="width:100%; padding:0.75rem; border:2px solid #ddd; border-radius:6px; font-size:1em;">
Â  Â  Â  Â  Â  <option value="">-- Choose a student --</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>
Â  Â  Â Â 
Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  <label>Subject</label>
Â  Â  Â  Â  <input type="text" id="composeStudentSubject" placeholder="Enter subject...">
Â  Â  Â  </div>
Â  Â  Â Â 
Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  <label>Message *</label>
Â  Â  Â  Â  <textarea id="composeStudentMessage" placeholder="Type your message here..." required></textarea>
Â  Â  Â  </div>

Â  Â  Â  <div style="display:flex; gap:1rem;">
Â  Â  Â  Â  <button class="btn-primary" onclick="sendMessageToStudent()">Send Message</button>
Â  S Â  Â  Â  <button class="btn-secondary" onclick="closeModal('composeToStudentModal')">Cancel</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  Â  <div id="composeSupportModal" class="modal">
Â  Â  <div class="modal-content">
Â  Â  t <h3>ğŸ†˜ New Support Ticket</h3>
Â  Â  Â Â 
Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  <label>Subject</label>
Â  Â  Â  Â  <input type="text" id="supportTicketSubject" placeholder="Enter subject...">
Â  Â  Â  </div>
Â  Â  Â Â 
Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  <label>Message *</label>
Â  Â  Â  Â  <textarea id="supportTicketMessage" placeholder="Describe your issue or question..." required></textarea>
Â  Â  Â  </div>

Â  Â  Â  <div style="display:flex; gap:1rem;">
Â  Â  Â  Â  <button class="btn-primary" onclick="sendSupportTicket()">Submit Ticket</button>
Â  Â  Â  Â  <button class="btn-secondary" onclick="closeModal('composeSupportModal')">Cancel</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  Â  <script>
Â  Â  const SUPABASE_URL = 'https://horqtcwnhwgodwlyqhli.supabase.co';
Â  Â  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhvcnF0Y3duaHdnb2R3bHlxaGxpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NjAyNzEsImV4cCI6MjA3NTMzNjI3MX0.4rYzW6MFEkVVqLor55RuFGLwE6WBJrYLxvYbgeXXRGU';
Â  Â  const DAILY_API_KEY = '8c3db949d2ace9fb8237c2db1e711fe4f8b57efcd97943c8ccb705824bf2ab5f';
Â  Â Â 
Â  Â  const { createClient } = supabase;
Â  Â  const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

Â  Â  let currentTeacherId = null;
Â  Â  let myStudents = [];
Â  Â  let unreadMessageCount = 0;
Â  Â  let unreadSupportCount = 0;
Â  Â  let wizardData = { studentId: "", studentName: "", subject: "", style: "", notes: "", date: "", time: "" };
Â  Â  let wizardStep = 0;

Â  Â  // ============================================
Â  Â  // AUTH & INITIALIZATION
Â  Â  // ============================================
Â  Â  async function checkTeacherAuth() {
Â  Â  Â  const { data: { session } } = await supabaseClient.auth.getSession();
Â  Â  Â Â 
Â  Â  Â  if (!session) {
Â  Â  Â  Â  window.location.href = 'teacher-login.html';
s Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  currentTeacherId = session.user.id;

Â  Â  Â  const { data: profile } = await supabaseClient
Â  Â  Â  Â  .from('profiles')
Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  .eq('id', currentTeacherId)
Â  Â  Â  Â  .single();

Â  Â  Â  if (!profile || profile.role !== 'teacher') {
Â  Â  Â  Â  alert('Access denied. Teachers only.');
Â  Â  Â  Â  window.location.href = 'teacher-login.html';
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  document.getElementById('teacherName').textContent = profile.full_name || 'Teacher';

Â  Â  Â  loadStats();
Â  Â  Â  loadSessions();
Â  Â  Â  loadStudents();
Â  Â  Â  loadInboxThreads();
Â  Â  Â  loadSupportThreads();

Â  Â  Â  // Subscribe to realtime messages
Â  Â  Â  supabaseClient
Â  Â  Â  Â  .channel('teacher_messages')
Â  Â  Â  Â  .on('postgres_changes', {Â 
Â  Â  Â  Â  Â  event: '*',Â 
Â  Â  Â  Â  Â  schema: 'public',Â 
Â  Â  Â  Â  Â  table: 'messages',
Â  Â  Â  Â  Â  filter: `recipient_id=eq.${currentTeacherId}`
Â  Â  Â  Â  }, () => {
Â  Â  Â  Â  Â  loadInboxThreads();
Â  Â  Â  Â  Â  loadSupportThreads();
Â  Â  Â  Â  Â  loadStats();
Â  s Â  Â  })
Â  Â  Â  Â  .subscribe();
Â  Â  }

Â  Â  async function logout() {
Â  Â  Â  await supabaseClient.auth.signOut();
Â  Â  Â  window.location.href = 'teacher-login.html';
Â  Â  }

Â  Â  // ============================================
Â  Â  // STATS
Â  Â  // ============================================
Â  Â  async function loadStats() {
Â  Â  Â  console.log('ğŸ“Š loadStats() called for teacher:', currentTeacherId);
Â  Â  Â Â 
Â  Â  Â  const { data: assignments } = await supabaseClient
Â  Â  Â  Â  .from('teacher_assignments')
Â  Â  Â  Â  .select('student_id')
Â  Â  Â  Â  .eq('teacher_id', currentTeacherId);

Â  Â  Â  console.log('ğŸ“Š Stats - assignments found:', assignments?.length || 0);

Â  Â  Â  const studentIds = assignments?.map(a => a.student_id) || [];

Â  Â  Â  const { data: sessions } = await supabaseClient
Â  Â  Â  Â  .from('bookings')
Â  Â  Â  Â  .select('id, status')
Â  Â  Â  Â  .eq('assigned_teacher_id', currentTeacherId);

Â  Â  Â  const { data: messages } = await supabaseClient
Â  Â  Â  Â  .from('messages')
Â  Â  Â  Â  .select('id')
Â  Â  Â  Â  .eq('recipient_id', currentTeacherId)
Â  Â  Â  Â  .eq('is_read', false);

Â  Â  Â  document.getElementById('totalStudents').textContent = studentIds.length || 0;
Â  Â  Â  document.getElementById('upcomingSessions').textContent =Â 
Â  Â  Â  Â  sessions?.filter(s => s.status === 'scheduled').length || 0;
Â  s Â  Â  document.getElementById('completedSessions').textContent =Â 
Â  Â  Â  Â  sessions?.filter(s => s.status === 'completed').length || 0;
Â  Â  Â  document.getElementById('unreadMessages').textContent = messages?.length || 0;
Â  Â  Â Â 
Â  Â  Â  console.log('ğŸ“Š Stats updated - Total students:', studentIds.length);
Â  Â  Â Â 
Â  Â  Â  unreadMessageCount = messages?.length || 0;
Â  Â  }

Â  Â  // ============================================
Â  section. Â  // SESSIONS MANAGEMENT
Â  Â  // ============================================
Â  Â  async function loadSessions() {
Â  Â  Â  const { data: bookings, error } = await supabaseClient
Â  Â  Â  Â  .from('bookings')
Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  .eq('assigned_teacher_id', currentTeacherId)
Â  Â  Â  Â  .order('session_date', { ascending: false });

Â  Â  Â  if (error) {
Â  Â  Â  Â  console.error('Error loading sessions:', error);
Â  Â  Â  Â  document.getElementById('upcomingSessionsBody').innerHTML = '<tr><td colspan="6" class="empty-state">Error loading sessions</td></tr>';
Â  Â  Â  Â  document.getElementById('completedSessionsBody').innerHTML = '<tr><td colspan="6" class="empty-state">Error loading sessions</td></tr>';
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  if (!bookings || bookings.length === 0) {
Â  Â  Â  Â  document.getElementById('upcomingSessionsBody').innerHTML = '<tr><td colspan="6" class="empty-state">No sessions yet. Create your first session!</td></tr>';
Â  Â  Â  Â  document.getElementById('completedSessionsBody').innerHTML = '<tr><td colspan="6" class="empty-state">No completed sessions yet.</td></tr>';
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const userIds = [...new Set(bookings.map(b => b.user_id))];
Â  Â  Â  const { data: profiles } = await supabaseClient
Â  Â  Â  Â  .from('profiles')
Â  Â  Â  Â  .select('id, full_name, email')
Â  Â  Â  Â  .in('id', userIds);

Â  Â  Â  const profileMap = {};
Â  Â  Â  profiles?.forEach(p => {
Â  Â  Â  Â  profileMap[p.id] = p;
Â  Â  Â  });

Â  Â  Â  const upcomingBookings = bookings.filter(b => b.status === 'scheduled');
Â  Â  Â  const completedBookings = bookings.filter(b => b.status === 'completed');

Â  Â  Â  const upcomingBody = document.getElementById('upcomingSessionsBody');
Â  Â  Â  if (upcomingBookings.length === 0) {
Â  Â  Â  Â  upcomingBody.innerHTML = '<tr><td colspan="6" class="empty-state">No upcoming sessions. Create a new session!</td></tr>';
s Â  Â  } else {
Â  Â  Â  Â  upcomingBody.innerHTML = upcomingBookings.map(booking => renderSessionRow(booking, profileMap, true)).join('');
Â  Â  Â  }

Â  Â  Â  const completedBody = document.getElementById('completedSessionsBody');
Â  Â  Â  if (completedBookings.length === 0) {
Â  Â  Â  Â  completedBody.innerHTML = '<tr><td colspan="6" class="empty-state">No completed sessions yet.</td></tr>';
Â  Â  Â  } else {
Â  Â  Â  Â  completedBody.innerHTML = completedBookings.map(booking => renderSessionRow(booking, profileMap, false)).join('');
Â  Â  Â  }
Â  Â  }

Â  Â  Â  Â  Â  Â  function renderSessionRow(booking, profileMap, isUpcoming) {
Â  Â  Â  const profile = profileMap[booking.user_id] || {};
Â  Â  Â  const studentIdentifier = booking.user_id ? `...${booking.user_id.slice(-8)}` : 'N/A';
Â  Â  Â  let dateStr, timeStr;

Â  Â  Â  if (booking.session_utc) {
Â  Â  Â  Â  const teacherTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
Â  Â  Â  Â  const utcDate = new Date(booking.session_utc);
Â  Â  Â  Â  dateStr = utcDate.toLocaleDateString('en-US', { timeZone: teacherTimezone, month: 'short', day: 'numeric', year: 'numeric' });
Â  Â  Â  Â  timeStr = utcDate.toLocaleTimeString('en-US', { timeZone: teacherTimezone, hour: '2-digit', minute: '2-digit', hour12: true }) + ` (${teacherTimezone})`;
Â  Â  Â  } else {
Â  Â  Â  Â  dateStr = booking.session_date ? new Date(booking.session_date).toLocaleDateString() : 'TBD';
Â  Â  Â  Â  timeStr = (booking.session_time || 'TBD') + ' âš ï¸ (Old format)';
Â  Â  Â  }

Â  Â  Â  let videoButton = '';
Â  Â  Â  if (isUpcoming) {
Â  Â  Â  Â  if (booking.video_link) {
Â  Â  Â  Â  Â  videoButton = `
Â  Â  Â  Â  Â  Â  <a href="${booking.video_link}" target="_blank" class="btn-small btn-video">ğŸ¥ Join Class</a>
Â  Â  Â  Â  Â  Â  <button class="btn-small" style="background:#2c2c2c; color:#fff; border: 2px solid #4CAF50;" onclick="openBlackboard('${booking.id}')">ğŸ–ï¸ Blackboard</button><br>`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  videoButton = `<button class="btn-small btn-create-room" onclick="createVideoRoom('${booking.id}')">ğŸ¬ Create Video Room</button><br>`;
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  const messageButton = isUpcomingÂ 
Â  Â  Â  Â  ? `<button class="btn-small btn-view" onclick="openComposeToStudentModal('${booking.user_id}')">ğŸ’¬ Message</button>`Â 
Â  Â  Â  Â  : '';

Â  Â  Â  const actionButtons = isUpcomingÂ 
Â  Â  Â  Â  ? `${videoButton}<button class="btn-small btn-complete" onclick="markComplete('${booking.id}')">Mark Complete</button>${messageButton}`
Â  Â  Â  Â  : '<span style="color:#28a745; font-weight:600;">âœ“ Completed</span>';

Â  Â  Â  return `
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  <strong>${profile.full_name || 'Unknown Student'}</strong><br>
Â  Â  Â  Â  Â  Â  <small style="color:#666;">Age: ${booking.age_group || 'N/A'}</small><br>
Â  Â  Â  Â  Â  Â  <small style="font-family: monospace; color: #999;">ID: ${studentIdentifier}</small>
Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  <strong>${booking.subject || 'N/A'}</strong><br>
s Â  Â  Â  Â  Â  <small style="color:#666;">Style: ${booking.learning_style || 'N/A'}</small>
Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  <td>${dateStr}</td>
Â  Â  Â  Â  Â  <td>${timeStr}</td>
Â  Â  Â  Â  Â  <td>${booking.help_needed ? `<small style="color:#666;">${booking.help_needed}</small>` : '<em style="color:#999;">No notes</em>'}</td>
Â  Â  Â  Â  Â  <td>${actionButtons}</td>
Â  Â  Â  Â  </tr>
Â  Â  Â  `;
Â  Â  }

Â  Â  async function createVideoRoom(bookingId) {
Â  Â  Â  const btn = event.target;
Â  Â  Â  btn.disabled = true;
Â  Â  Â  btn.textContent = 'â³ Creating...';
Â  Â  Â  const roomName = `stemsphere-teacher-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
Â  Â  Â Â 
Â  Â  Â  try {
Â  Â  Â  Â  const dailyResponse = await fetch('https://api.daily.co/v1/rooms', {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${DAILY_API_KEY}` },
s Â  Â  Â  Â  body: JSON.stringify({ name: roomName, privacy: 'public', properties: { enable_screenshare: true, enable_chat: true, start_video_off: false, start_audio_off: false, max_participants: 10, enable_knocking: false, enable_prejoin_ui: true } })
Â  Â  Â  Â  });

Â  Â  Â  Â  if (!dailyResponse.ok) {
Â  Â  Â  Â  Â  const errorData = await dailyResponse.json();
Â  Â  Â  Â  Â  throw new Error(errorData.info || errorData.error || 'Failed to create video room');
Â  Â  Â  Â  }

Â  Â  Â  Â  const roomData = await dailyResponse.json();
Â  Â  Â  Â  const videoLink = roomData.url;

Â  Â  Â  Â  const { error } = await supabaseClient.from('bookings').update({ video_link: videoLink }).eq('id', bookingId);
Â  Â  Â  Â  if (error) throw new Error(error.message);
Â  Â  Â  Â Â 
Â  Â  Â  Â  await loadSessions();
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  alert('âŒ Failed to create video room: ' + error.message);
Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  btn.textContent = 'ğŸ¬ Create Video Room';
Â  Â  Â  }
Â  Â  }

Â  Â  async function markComplete(bookingId) {
Â  Â  Â  const { error } = await supabaseClient.from('bookings').update({ status: 'completed' }).eq('id', bookingId);

Â  Â  Â  if (error) {
Â  Â  Â  Â  alert('Error: ' + error.message);
Â  Â  Â  } else {
Â  Â  Â  Â  await loadStats();
Â  Â  Â  Â  await loadSessions();
Â  Â  Â  }
Â  Â  }

Â  Â  // ============================================
Â  Â  // STUDENTS MANAGEMENT
Â  Â  // ============================================
Â  Â  async function loadStudents() {
Â  Â  Â  const { data: assignments, error: assignError } = await supabaseClient.from('teacher_assignments').select('student_id').eq('teacher_id', currentTeacherId);
Â  Â  Â  const tbody = document.getElementById('studentsBody');

Â  Â  Â  if (assignError) {
Â  Â  Â  Â  tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Error loading assignments</td></tr>'; return;
Â  Â  Â  }
Â  Â  Â  if (!assignments || assignments.length === 0) {
Â  Â  Â  Â  tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No students assigned yet. Contact your admin.</td></tr>'; myStudents = []; return;
Â  Â  Â  }

Â  Â  Â  const studentIds = assignments.map(a => a.student_id);
Â  Â  Â  const { data: students, error: studentsError } = await supabaseClient.from('profiles').select('*').in('id', studentIds);

Â  Â  Â  if (studentsError) {
Â  Â  Â  Â  tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Error loading students</td></tr>'; return;
Â  Â  Â  }
Â  Â  Â  if (!students || students.length === 0) {
Â  Â  Â  Â  tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No student profiles found.</td></tr>'; myStudents = []; return;
Â  Â  Â  }

Â  Â  Â  myStudents = students;
Â  Â  Â  const { data: bookings } = await supabaseClient.from('bookings').select('user_id').eq('assigned_teacher_id', currentTeacherId);

Â  Â  Â  tbody.innerHTML = students.map(student => {
Â  Â  Â  Â  const sessionCount = bookings?.filter(b => b.user_id === student.id).length || 0;
Â  Â  Â  Â  const studentIdentifier = student.id ? `...${student.id.slice(-8)}` : 'N/A';
source. 
Â  Â  Â  Â Â 
Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <td><strong>${student.full_name}</strong></td>
Â  Â  Â  Â  Â  Â  <td><span style="font-family: monospace; color: #999;">${studentIdentifier}</span></td>
Â  Â  Â  Â  Â  Â  <td>${student.age_group || 'N/A'}</td>
Â  Â  Â  Â  Â  Â  <td>${sessionCount}</td>
Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-view" onclick="openComposeToStudentModal('${student.id}')">ğŸ’¬ Message</button>
Â  Â  Â  Â  Â  Â  Â  <button class="btn-small" style="background:#28a745; color:#fff;" onclick="createSessionForStudent('${student.id}')">â• Create Session</button>
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  `;
Â  Â  Â  }).join('');
Â  Â  }

Â  Â  function createSessionForStudent(studentId) {
Â  Â  Â  const student = myStudents.find(s => s.id === studentId);
Â  Â  Â  if (!student) return;

Â  Â  Â  wizardData.studentId = studentId;
Â  Â  Â  wizardData.studentName = student.full_name;
Â  Â  Â  openCreateSessionWizard();
Â  Â  }

Â  Â  // ============================================
Â  Â  // STUDENT MESSAGING SYSTEM
Â  Â  // ============================================
Â  Â  async function loadInboxThreads() {
Â  Â  Â  const { data: assignments } = await supabaseClient.from('teacher_assignments').select('student_id').eq('teacher_id', currentTeacherId);
Â  Â  Â  if (!assignments || assignments.length === 0) {
Â  Â  Â  Â  document.getElementById('inboxThreads').innerHTML = '<div class="empty-state">No students assigned yet.</div>'; return;
Â  Â  Â  }

Â  Â  Â  const studentIds = assignments.map(a => a.student_id);
Â  Â  Â  const { data: messages } = await supabaseClient.from('messages').select('*').eq('message_type', 'teacher_student').or(`and(sender_id.in.(${studentIds.join(',')}),recipient_id.eq.${currentTeacherId}),and(sender_id.eq.${currentTeacherId},recipient_id.in.(${studentIds.join(',')}))`).order('created_at', { ascending: false });
Â  Â  Â  const { data: students } = await supabaseClient.from('profiles').select('id, full_name').in('id', studentIds);

Â  Â  Â  const studentMap = {};
Â  Â  Â  students?.forEach(s => { studentMap[s.id] = s.full_name; });

s Â  Â  const threads = {};
Â  Â  Â  messages?.forEach(msg => {
Â  Â  Â  Â  const studentId = msg.sender_id === currentTeacherId ? msg.recipient_id : msg.sender_id;
Â  Â  Â  Â  if (!threads[studentId]) {
Â  Â  Â  Â  Â  threads[studentId] = { studentId: studentId, studentName: studentMap[studentId] || 'Unknown Student', messages: [], lastMessageDate: new Date(msg.created_at), unreadCount: 0, totalCount: 0 };
Â  Â  Â  Â  }
Â  Â  Â  Â  threads[studentId].messages.push(msg);
Â  Â  Â  Â  threads[studentId].totalCount++;
Â  Â  Â  Â  if (msg.recipient_id === currentTeacherId && !msg.is_read) { threads[studentId].unreadCount++; }
Â  Â  Â  Â  const msgDate = new Date(msg.created_at);
Â  Â  Â  Â  if (msgDate > threads[studentId].lastMessageDate) { threads[studentId].lastMessageDate = msgDate; }
Â  Â  Â  });

Â  Â  Â  const threadArray = Object.values(threads).sort((a, b) => b.lastMessageDate - a.lastMessageDate);
Â  Â  Â  const totalUnread = threadArray.reduce((sum, thread) => sum + thread.unreadCount, 0);
Â  Â  Â  updateBadge('inboxBadge', totalUnread);
Â  Â  Â  renderThreads(threadArray);
Â  Â  }

Â  Â  function renderThreads(threads) {
Â  Â  Â  const container = document.getElementById('inboxThreads');
Â  Â  Â  if (!threads || threads.length === 0) {
Â  Â  Â  Â  container.innerHTML = '<div class="empty-state">No messages yet. Click "Message a Student" to start a conversation!</div>'; return;
Â  Â  Â  }

Â  Â  Â  container.innerHTML = threads.map(thread => {
Â  Â  Â  Â  const lastMessage = thread.messages[0];
Â  Â  Â  Â  const lastMessagePreview = lastMessage.message.substring(0, 80) + (lastMessage.message.length > 80 ? '...' : '');
Â  Â  Â  Â  const lastMessageFrom = lastMessage.sender_id === currentTeacherId ? 'You: ' : '';
Â  Â  Â  Â  const unreadClass = thread.unreadCount > 0 ? 'unread' : '';
Â  Â  Â  Â  const dateStr = thread.lastMessageDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  <div class="thread-item ${unreadClass}" onclick="openConversation('${thread.studentId}')">
Â  Â  Â  Â  Â  Â  <div class="thread-header">
Â  Â  Â  Â  Â  Â  Â  <div class="student-name">${thread.studentName}</div>
Â  Â  Â  Â  Â  Â  Â  <div class="thread-meta">
Â  Â  Â  Â  Â  Â  Â  Â  ${thread.unreadCount > 0 ? `<span class="unread-count">${thread.unreadCount} new</span>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  <span class="message-count">${thread.totalCount} message${thread.totalCount !== 1 ? 's' : ''}</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="last-message-date">${dateStr}</span>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="last-message-preview">${lastMessageFrom}${lastMessagePreview}</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  }).join('');
Â  Â  }

Â  Â  async function openConversation(studentId) {
Â  Â  Â  const student = myStudents.find(s => s.id === studentId);
Â  Â  Â  const studentName = student ? student.full_name : 'Student';
Â  Â  Â  const { data: messages } = await supabaseClient.from('messages').select('*').eq('message_type', 'teacher_student').or(`and(sender_id.eq.${studentId},recipient_id.eq.${currentTeacherId}),and(sender_id.eq.${currentTeacherId},recipient_id.eq.${studentId})`).order('created_at', { ascending: true });

Â  Â  Â  if (!messages) { alert('Error loading conversation'); return; }

Â  Â  Â  const unreadMessageIds = messages.filter(m => m.recipient_id === currentTeacherId && !m.is_read).map(m => m.id);
Â  Â  Â  if (unreadMessageIds.length > 0) {
Â  Â  Â  Â  await supabaseClient.from('messages').update({ is_read: true }).in('id', unreadMessageIds);
Â  Â  Â  }

Â  Â  Â  const conversationHTML = `
Â  Â  Â  Â  <div class="conversation-header"><h4>ğŸ’¬ Conversation with ${studentName}</h4><p>${messages.length} message${messages.length !== 1 ? 's' : ''} in this thread</p></div>
Â  Â  Â  Â  ${messages.map(msg => {
Â  Â  Â  Â  Â  const isFromMe = msg.sender_id === currentTeacherId;
Â  Â  Â  Â  Â  const bubbleClass = isFromMe ? 'from-me' : 'from-student';
Â  Â  Â  Â  Â  const date = new Date(msg.created_at).toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
s Â  Â  Â  Â  return `<div class="message-bubble ${bubbleClass}"><div class="sender">${isFromMe ? 'You' : studentName}</div><div class="timestamp">${date}</div>${msg.subject && msg.subject !== 'No subject' ? `<div class="subject">${msg.subject}</div>` : ''}<div class="body">${msg.message}</div></div>`;
Â  Â  Â  Â  }).join('')}
Â  Â  Â  Â  <div class="reply-box"><h5>ğŸ’¬ Reply to ${studentName}</h5><div class="form-group"><label>Subject (optional)</label><input type="text" id="replySubject" placeholder="Enter subject..."></div><div class="form-group"><label>Your Message *</label><textarea id="replyMessage" placeholder="Type your reply here..." style="min-height:120px;"></textarea></div><div style="display:flex; gap:1rem;"><button class="btn-primary" onclick="sendReplyInConversation('${studentId}')">Send Reply</button><button class="btn-secondary" onclick="closeModal('conversationModal')">Close</button></div></div>
Â  Â  Â  `;
Â  Â  Â  document.getElementById('conversationContent').innerHTML = conversationHTML;
Â  Â  Â  document.getElementById('conversationModal').classList.add('active');
Â  Â  Â  loadInboxThreads();
Â  Â  Â  loadStats();
Â  Â  }
Â  Â Â 
Â  Â  async function sendReplyInConversation(studentId) {
Â  Â  Â  Â  const subject = document.getElementById('replySubject').value.trim();
Â  Â  Â  Â  const message = document.getElementById('replyMessage').value.trim();
Â  Â  Â  Â  if (!message) { alert('Please enter a message'); return; }

Â  Â  Â  Â  const { error } = await supabaseClient.from('messages').insert({ sender_id: currentTeacherId, recipient_id: studentId, message_type: 'teacher_student', subject: subject || 'Reply from your teacher', message: message });
Â  Â  Â  Â  if (error) { alert('Error sending message: ' + error.message); return; }

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const { data: student } = await supabaseClient.from('profiles').select('email, full_name').eq('id', studentId).single();
Â  Â  Â  Â  Â  Â  const { data: currentUser } = await supabaseClient.from('profiles').select('full_name').eq('id', currentTeacherId).single();
Â  Â  Â  Â  Â  Â  if (student && currentUser) {
Â  Â  Â  Â  Â  Â  Â  Â  fetch(`${SUPABASE_URL}/functions/v1/send-notification-email`, {
s Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_KEY}` },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ type: 'new_message_to_student', to: student.email, data: { recipientName: student.full_name, senderName: currentUser.full_name, subject: subject || 'New message', message: message } })
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (emailError) { console.error('âš ï¸ Email notification failed (non-critical):', emailError); }

Â  Â  Â  Â  closeModal('conversationModal');
Â  Â  Â  Â  await openConversation(studentId);
Â  Â  Â  Â  await loadInboxThreads();
Â  Â  Â  Â  await loadStats();
Â  Â  }

Â  Â  function openComposeToStudentModal(studentIdToSelect = null) {
Â  Â  Â  const select = document.getElementById('composeStudentSelect');
Â  Â  Â  select.innerHTML = '<option value="">-- Choose a student --</option>' + myStudents.map(student => `<option value="${student.id}">${student.full_name}</option>`).join('');
Â  Â  Â  if (studentIdToSelect) { select.value = studentIdToSelect; }
Â  Â  Â  document.getElementById('composeStudentSubject').value = '';
Â  Â  Â  document.getElementById('composeStudentMessage').value = '';
Â  Â  Â  document.getElementById('composeToStudentModal').classList.add('active');
Â  Â  }

Â  Â  async function sendMessageToStudent() {
Â  Â  Â  const studentId = document.getElementById('composeStudentSelect').value;
Â  Â  Â  const subject = document.getElementById('composeStudentSubject').value.trim();
Â  Â  Â  const message = document.getElementById('composeStudentMessage').value.trim();
Â  Â  Â  if (!studentId) { alert('Please select a student'); return; }
Â  Â  Â  if (!message) { alert('Please enter a message'); return; }

Â  Â  Â  const { error } = await supabaseClient.from('messages').insert({ sender_id: currentTeacherId, recipient_id: studentId, message_type: 'teacher_student', subject: subject || 'Message from your teacher', message: message });
Â  Â  Â  if (error) { alert('Error sending message: ' + error.message); return; }
Â  Â  Â Â 
Â  Â  Â  closeModal('composeToStudentModal');
Â  Â  Â  loadInboxThreads();
Â  Â  }

Â  Â  // ============================================
Â  Â  // SUPPORT TICKET SYSTEM
Â  Â  // ============================================
Â  Â  async function loadSupportThreads() {
Â  Â  Â  const { data: admins } = await supabaseClient.from('profiles').select('id').eq('role', 'admin');
source. Â  Â  Â  if (!admins || admins.length === 0) { document.getElementById('teacherSupportMessages').innerHTML = '<div class="empty-state">Support unavailable. Please try again later.</div>'; return; }

Â  Â  Â  const { data: messages } = await supabaseClient.from('messages').select('*').eq('message_type', 'teacher_support').or(`sender_id.eq.${currentTeacherId},recipient_id.eq.${currentTeacherId}`).order('created_at', { ascending: false });
Â  Â  Â  unreadSupportCount = messages?.filter(m => m.recipient_id === currentTeacherId && !m.is_read).length || 0;
Â  Â  Â  updateBadge('supportBadge', unreadSupportCount);

Â  Â  Â  if (!messages || messages.length === 0) { document.getElementById('teacherSupportMessages').innerHTML = '<div class="empty-state">No support tickets yet. Click "New Support Ticket" if you need help!</div>'; return; }

Â  Â  Â  const lastMessage = messages[0];
Â  Â  Â  const lastMessagePreview = lastMessage.message.substring(0, 80) + (lastMessage.message.length > 80 ? '...' : '');
s Â  Â  const lastMessageFrom = lastMessage.sender_id === currentTeacherId ? 'You: ' : '';
Â  Â  Â  const unreadClass = unreadSupportCount > 0 ? 'unread' : '';
Â  Â  Â  const dateStr = new Date(lastMessage.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

Â  Â  Â  document.getElementById('teacherSupportMessages').innerHTML = `
Â  Â  Â  Â  <div class="thread-item ${unreadClass}" onclick="openSupportConversation()">
Â  Â  Â  Â  Â  <div class="thread-header"><div class="student-name">Support Team</div><div class="thread-meta">${unreadSupportCount > 0 ? `<span class="unread-count">${unreadSupportCount} new</span>` : ''}<span class="message-count">${messages.length} message${messages.length !== 1 ? 's' : ''}</span><span class="last-message-date">${dateStr}</span></div></div>
Â  Â  Â  Â  Â  <div class="last-message-preview">${lastMessageFrom}${lastMessagePreview}</div>
Â  Â  Â  Â  </div>`;
Â  Â  }

Â  Â  async function openSupportConversation() {
Â  Â  Â  const { data: messages } = await supabaseClient.from('messages').select('*').eq('message_type', 'teacher_support').or(`sender_id.eq.${currentTeacherId},recipient_id.eq.${currentTeacherId}`).order('created_at', { ascending: true });
Â  Â  Â  if (!messages) { alert('Error loading conversation'); return; }

Â  Â  Â  const unreadMessageIds = messages.filter(m => m.recipient_id === currentTeacherId && !m.is_read).map(m => m.id);
Â  Â  Â  if (unreadMessageIds.length > 0) {
Â  Â  Â  Â  await supabaseClient.from('messages').update({ is_read: true }).in('id', unreadMessageIds);
Â  Â  Â  }

Â  Â  Â  const conversationHTML = `
Â  Â  Â  Â  <div class="conversation-header"><h4>ğŸ’¬ Conversation with Support Team</h4><p>${messages.length} message${messages.length !== 1 ? 's' : ''} in this thread</p></div>
Â  Â  Â  Â  ${messages.map(msg => {
Â  Â  Â  Â  Â  const isFromMe = msg.sender_id === currentTeacherId;
Â  Â  Â  Â  Â  const bubbleClass = isFromMe ? 'from-me' : 'from-support';
Â  Â  Â  Â  Â  const date = new Date(msg.created_at).toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
s Â  Â  Â  Â  return `<div class="message-bubble ${bubbleClass}"><div class="sender">${isFromMe ? 'You' : 'Support Team'}</div><div class="timestamp">${date}</div>${msg.subject && msg.subject !== 'No subject' ? `<div class="subject">${msg.subject}</div>` : ''}<div class="body">${msg.message}</div></div>`;
Â  Â  Â  Â  }).join('')}
Â  Â  Â  Â  <div class="reply-box"><h5>ğŸ’¬ Reply to Support</h5><div class="form-group"><label>Subject (optional)</label><input type="text" id="supportReplySubject" placeholder="Enter subject..."></div><div class="form-group"><label>Your Message *</label><textarea id="supportReplyMessage" placeholder="Type your reply here..." style="min-height:120px;"></textarea></div><div style="display:flex; gap:1rem;"><button class="btn-primary" onclick="sendSupportReply()">Send Reply</button><button class="btn-secondary" onclick="closeModal('supportConversationModal')">Close</button></div></div>`;
Â  Â  Â  document.getElementById('supportConversationContent').innerHTML = conversationHTML;
Â  Â  Â  document.getElementById('supportConversationModal').classList.add('active');
Â  Â  Â  loadSupportThreads();
Â  Â  }

Â  Â  async function sendSupportReply() {
Â  Â  Â  const subject = document.getElementById('supportReplySubject').value.trim();
source. Â  Â  Â  const message = document.getElementById('supportReplyMessage').value.trim();
Â  Â  Â  if (!message) { alert('Please enter a message'); return; }

Â  Â  Â  const { data: admins } = await supabaseClient.from('profiles').select('id').eq('role', 'admin').limit(1).single();
Â  Â  Â  if (!admins) { alert('No admin available'); return; }

Â  Â  Â  const { error } = await supabaseClient.from('messages').insert({ sender_id: currentTeacherId, recipient_id: admins.id, message_type: 'teacher_support', subject: subject || 'Reply to support', message: message });
Â  Â  Â  if (error) { alert('Error sending message: ' + error.message); return; }

Â  Â  Â  closeModal('supportConversationModal');
Â  Â  Â  openSupportConversation();
Â  Â  }

Â  Â  function openTeacherSupportModal() {
Â  Â  Â  document.getElementById('supportTicketSubject').value = '';
Â  Â  s Â  document.getElementById('supportTicketMessage').value = '';
Â  Â  Â  document.getElementById('composeSupportModal').classList.add('active');
Â  Â  }

Â  Â  async function sendSupportTicket() {
Â  Â  Â  const subject = document.getElementById('supportTicketSubject').value.trim();
Â  Â  Â  const message = document.getElementById('supportTicketMessage').value.trim();
Â  Â  Â  if (!message) { alert('Please enter a message'); return; }

Â  Â  Â  const { data: admins } = await supabaseClient.from('profiles').select('id').eq('role', 'admin').limit(1).single();
s Â  Â  if (!admins) { alert('No admin available. Please try again later.'); return; }

Â  Â  Â  const { error } = await supabaseClient.from('messages').insert({ sender_id: currentTeacherId, recipient_id: admins.id, message_type: 'teacher_support', subject: subject || 'Support Ticket', message: message });
Â  Â  Â  if (error) { alert('Error sending ticket: ' + error.message); return; }

Â  Â  Â  closeModal('composeSupportModal');
Â  Â  Â  loadSupportThreads();
Â  Â  }

Â  Â  function updateBadge(badgeId, count) {
Â  Â  Â  const badge = document.getElementById(badgeId);
s Â  Â  if (count > 0) { badge.textContent = count; badge.style.display = 'flex'; }Â 
Â  Â  Â  else { badge.style.display = 'none'; }
Â  Â  }

Â  Â  function showTab(tabName) {
Â  Â  Â  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
Â  Â  Â  event.target.classList.add('active');
Â  Â  Â  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
Â  Â  Â  document.getElementById(tabName + 'Tab').classList.add('active');
Â  Â  Â  if (tabName === 'inbox') { loadInboxThreads(); }Â 
Â  Â  Â  else if (tabName === 'support') { loadSupportThreads(); }
section. Â  }

Â  Â  function closeModal(modalId) {
Â  Â  Â  document.getElementById(modalId).classList.remove('active');
Â  Â  }

Â  Â  // ============================================
Â  Â  // CREATE SESSION WIZARD
Â  Â  // ============================================
Â  Â  function updateProgress(percent) {
Â  Â  Â  document.getElementById('wizardProgressFill').style.width = percent + '%';
Â  Â  }

Â  Â  function openCreateSessionWizard() {
Â  Â  Â  wizardStep = 0;
Â  Â  Â  const detectedTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
Â  Â  Â  if (!wizardData.studentId) {
Â  Â  Â  Â  wizardData = { studentId: "", studentName: "", subject: "", style: "", notes: "", date: "", time: "", timezone: detectedTimezone };
s Â  Â  } else {
Â  Â  Â  Â  wizardData.timezone = detectedTimezone;
Â  Â  Â  }
Â  Â  Â  document.getElementById('sessionWizard').classList.add('active');
Â  Â  Â  updateProgress(0);
Â  Â  Â  renderWizardStep();
Â  Â  }

Â  Â  function closeSessionWizard() {
Â  Â  Â  document.getElementById('sessionWizard').classList.remove('active');
Â  Â  Â  wizardData = { studentId: "", studentName: "", subject: "", style: "", notes: "", date: "", time: "", timezone: "" };
Â  Â  }

Â  Â  function renderWizardStep() {
Â  Â  Â  const c = document.getElementById('wizardContent');

Â  Â  Â  if(wizardStep === 0) {
Â  Â  Â  Â  updateProgress(10);
Â  Â  Â  Â  c.innerHTML = `<h2 style="padding:0 20px; color:#000;">ğŸ“… Create New Session</h2><p style="padding:0 20px; color:#666; margin-bottom:1rem;">Schedule a session with one of your students</p><button onclick="wizardStep=1; renderWizardStep()" style="margin:20px; background:linear-gradient(90deg,#007bff,#00c6ff); color:#fff; padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:600;">Begin</button>`;
Â  Â  Â  } else if(wizardStep === 1) {
Â  Â  Â  Â  updateProgress(20);
Â  Â  Â  Â  if (wizardData.studentId) { wizardStep = 2; renderWizardStep(); return; }
Â  Â  Â  Â  c.innerHTML = `<h3 style="padding:0 20px; color:#000;">ğŸ‘¥ Select Student:</h3><p style="padding:0 20px; color:#666;">Choose which student this session is for</p><div class="student-select-grid" style="margin:0 20px;">${myStudents.map(student => `<div class="student-card" onclick="selectStudent('${student.id}', '${student.full_name.replace(/'/g, "\\'")}')"><h4>${student.full_name}</h4><p style="color:#007bff; font-weight:600;">${student.age_group || 'N/A'}</p></div>`).join('')}</div>`;
Â  Â  Â  } else if(wizardStep === 2) {
Â  Â  Â  Â  updateProgress(40);
Â  Â  Â  Â  c.innerHTML = `<h3 style="padding:0 20px; color:#000;">ğŸ“˜ Choose Subject:</h3><p style="padding:0 20px; color:#666; margin-bottom:1rem;">Student: <strong>${wizardData.studentName || 'Selected'}</strong></p><div style="display:flex; flex-wrap:wrap; gap:10px; padding:0 20px;">${["Math","Chemistry","English (Public Speaking)","Python Programming","Biology","English Speaking and Writing","Physics","History","Other"].map(s => `<button onclick="wizardData.subject='${s}'; wizardStep=3; renderWizardStep()" style="background:linear-gradient(90deg,#007bff,#00c6ff); color:#fff; padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:600;">${s}</button>`).join("")}</div>`;
Â  Â  Â  } else if(wizardStep === 3) {
Â  Â  Â  Â  updateProgress(60);
Â  Â  Â  Â  c.innerHTML = `<h3 style="padding:0 20px; color:#000;">ğŸ“ Session Type:</h3><div style="display:flex; flex-wrap:wrap; gap:10px; padding:0 20px;">${["1-on-1 Tutoring","Group Class","Review Session","Test Prep","Homework Help"].map(style => `<button onclick="wizardData.style='${style}'; wizardStep=4; renderWizardStep()" style="background:linear-gradient(90deg,#007bff,#00c6ff); color:#fff; padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:600;">${style}</button>`).join("")}</div>`;
Â  Â  Â  } else if(wizardStep === 4) {
Â  Â  Â  Â  updateProgress(80);
Â  Â  Â  Â  c.innerHTML = `<h3 style="padding:0 20px; color:#000;">ğŸ“ Session Notes (Optional):</h3><p style="padding:0 20px; color:#666;">Add any notes about what you'll cover in this session</p><div style="border:1px solid #ccc; border-radius:5px; padding:10px; margin:10px 20px;">
Â  Â  Â  Â  Â  Â  <textarea id="sessionNotes" placeholder="e.g., Review chapter 5, practice problems..."
Â  Â  Â  Â  Â  Â  Â  style="width:100%; padding:10px; height:100px; border:none; resize:vertical; font-size:14px;"></textarea>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <button onclick="wizardData.notes=document.getElementById('sessionNotes').value; wizardStep=5; renderWizardStep()"Â 
Â  Â  Â  Â  Â  Â  style="margin:0 20px 20px; background:linear-gradient(90deg,#007bff,#00c6ff); color:#fff; padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:600;">Continue</button>
Â  Â  Â  Â  `;
Â  Â  Â  } else if(wizardStep === 5) {
Â  Â  Â  Â  updateProgress(90);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const today = new Date();
Â  Â  Â  Â  const minDate = today.toISOString().split('T')[0];
Â  Â  Â  Â  const maxDate = new Date(today.getTime() + (90 * 24 * 60 * 60 * 1000)).toISOString().split('T')[0];
Â  Â  Â  Â Â 
Â  Â  Â  Â  c.innerHTML = `
Â  Â  Â  Â  Â  <h3 style="padding:0 20px; color:#000;">ğŸ“… Select Date & Time</h3>
Â  Â  Â  Â  Â  <p style="padding:0 20px; color:#28a745; font-weight:600; margin-bottom:1rem;">âœ… Schedule in your timezone - students see it in theirs!</p>
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  <div style="padding:0 20px; margin-bottom:1.5rem; background:#e3f2fd; border-radius:8px; padding:1rem;">
Â  Â  Â  Â  Â  Â  <label style="display:block; margin-bottom:0.5rem; font-weight:600; color:#007bff;">ğŸŒ Your Timezone:</label>
Â  Â  Â  Â  Â  Â  <select id="teacherTimezoneSelect" onchange="updateTeacherTimezone()" style="width:100%; max-width:500px; padding:0.75rem; border:2px solid #007bff; border-radius:6px; font-size:1em; font-weight:600;">
source. Â  Â  Â  Â  Â  <option value="${wizardData.timezone}">ğŸ“ ${wizardData.timezone} (Auto-detected)</option>
Â  Â  Â  Â  Â  Â  Â  <optgroup label="ğŸ‡ºğŸ‡¸ United States">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="America/New_York">Eastern Time (ET)</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="America/Chicago">Central Time (CT)</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="America/Denver">Mountain Time (MT)</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="America/Los_Angeles">Pacific Time (PT)</option>
Â  Â  Â  Â  Â  Â  Â  </optgroup>
Â  Â  Â  Â  Â  Â  Â  <optgroup label="ğŸ‡¬ğŸ‡§ğŸ‡ªğŸ‡º Europe">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Europe/London">London (GMT)</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Europe/Paris">Paris (CET)</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Europe/Berlin">Berlin (CET)</option>
Â  Â  Â  Â  Â  Â  Â  </optgroup>
Â  Â  Â  Â  Â  Â  Â  <optgroup label="ğŸŒ Asia Pacific">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Asia/Dubai">Dubai (GST)</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Asia/Singapore">Singapore (SGT)</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Asia/Hong_Kong">Hong Kong (HKT)</option>
s Â  Â  Â  Â  Â  Â  Â  <option value="Asia/Tokyo">Tokyo (JST)</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Australia/Sydney">Sydney (AEDT)</option>
Â  Â  Â  Â  Â  Â  Â  </optgroup>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  <p style="font-size:0.85em; color:#0056b3; margin-top:0.5rem; font-weight:500;">â° Times shown are in YOUR timezone. Students see it converted to theirs.</p>
section. Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div style="padding:0 20px;">
Â  Â  Â  Â  Â  Â  <label style="display:block; margin-bottom:0.5rem; font-weight:600;">ğŸ“† Select Date:</label>
Â  Â  Â  Â  Â  Â  <input type="date" id="sessionDate"Â 
Â  Â  Â  Â  Â  Â  Â  min="${minDate}"Â 
Â  Â  Â  Â  Â  Â  Â  max="${maxDate}"
Â  Â  Â  Â  Â  Â  Â  onchange="generateTeacherTimeSlots()"
Â  Â  Â  Â  Â  Â  Â  style="width:100%; max-width:300px; padding:0.75rem; border:1px solid #ddd; border-radius:6px; font-size:1em;">
Â  Â  Â  Â  Â  Â  <p style="font-size:0.85em; color:#666; margin-top:0.5rem;">Schedule up to 90 days in advance</p>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div id="timeSlotsTeacher" style="padding:0 20px; margin-top:1rem;"></div>

Â  Â  Â  Â  Â  <button id="createSessionBtn" onclick="confirmSessionCreation()"Â 
Â  Â  Â  Â  Â  Â  style="margin:20px; background:#28a745; color:#fff; padding:12px 24px; border:none; border-radius:6px; cursor:pointer; font-weight:600; display:none;">
s Â  Â  Â  Â  Â  Create Session
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  `;
Â  Â  Â  }
Â  Â  }

Â  Â  function selectStudent(studentId, studentName) {
Â  Â  Â  wizardData.studentId = studentId;
Â  Â  Â  wizardData.studentName = studentName;
Â  Â  Â  wizardStep = 2;
Â  Â  Â  renderWizardStep();
Â  Â  }

Â  Â  function updateTeacherTimezone() {
Â  Â  Â  const selectedTimezone = document.getElementById('teacherTimezoneSelect').value;
Â  Â  Â  wizardData.timezone = selectedTimezone;
Â  Â  Â  const selectedDate = document.getElementById('sessionDate').value;
Â  Â  Â  if (selectedDate) {
Â  Â  Â  Â  generateTeacherTimeSlots();
Â  Â  Â  }
Â  Â  }

Â  Â  function generateTeacherTimeSlots() {
Â  Â  Â  const selectedDate = document.getElementById('sessionDate').value;
Â  Â  Â  if (!selectedDate) return;

Â  Â  Â  const date = new Date(selectedDate + 'T00:00:00');
Â  Â  Â  const slots = [];
Â  Â  Â Â 
Â  Â  Â  for (let hour = 0; hour < 24; hour++) {
Â  Â  Â  Â  for (let min = 0; min < 60; min += 30) {
Â  Â  Â  Â  Â  const timeStr24 = `${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
Â  Â  Â  Â  Â  const period = hour >= 12 ? 'PM' : 'AM';
Â  Â  Â  Â  Â  const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
Â  Â  Â  Â  Â  const timeStr12 = `${displayHour}:${min.toString().padStart(2, '0')} ${period}`;
Â  Â  Â  Â  Â  slots.push({ time24: timeStr24, time12: timeStr12 });
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  wizardData.date = selectedDate;
Â  Â  Â source. 
Â  Â  Â  const container = document.getElementById('timeSlotsTeacher');
Â  Â  Â  container.innerHTML = `
Â  Â  Â  Â  <p style="margin-bottom:0.5rem; font-weight:600;">â° Select Time (6 AM - 10 PM):</p>
Â  Â  Â  Â  <div class="time-slots">
Â  Â  Â  Â  Â  ${slots.map(slot =>Â 
Â  Â  Â  Â  Â  Â  `<div class="time-slot" onclick="selectSessionTime('${slot.time24}')" data-time="${slot.time24}">${slot.time12}</div>`
Â  Â  Â  Â  Â  ).join('')}
Â  Â  Â  Â  </div>
Â  Â  Â  `;
Â  Â  }

Â  Â  function selectSessionTime(time) {
Â  Methods: Â  Â  document.querySelectorAll('.time-slot').forEach(slot => {
Â  Â  Â  Â  slot.classList.remove('selected');
Â  Â  Â  });
Â  Â  Â  event.target.classList.add('selected');
Â  Â  Â  wizardData.time = time;
Â  Â  Â  document.getElementById('createSessionBtn').style.display = 'block';
Â  Â  Â  updateProgress(100);
Â  Â  }

Â  Â  async function confirmSessionCreation() {
Â  Â  Â  if (!wizardData.studentId || !wizardData.date || !wizardData.time) {
Â  Â  Â  Â  alert('Please complete all required fields');
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const btn = document.getElementById('createSessionBtn');
Â  Â  Â  btn.disabled = true;
Â  Â  Â  btn.textContent = 'â³ Creating session...';

Â  Â  Â  try {
Â  Â  Â  Â  const student = myStudents.find(s => s.id === wizardData.studentId);
s Â  Â  Â  const localDateTime = `${wizardData.date}T${wizardData.time}`;
Â  Â  Â  Â  const utcTimestamp = convertToUTC(localDateTime, wizardData.timezone);

Â  Â  Â  Â  const { error } = await supabaseClient
Â  Â  Â  Â  Â  .from('bookings')
Â  Â  Â  Â  Â  .insert({
Â  Â  Â  Â  Â  Â  user_id: wizardData.studentId,
Â  Â  Â  Â  Â  Â  assigned_teacher_id: currentTeacherId,
Â  Â  Â  Â  Â  Â  subject: wizardData.subject,
Â  Â  Â  Â  Â  Â  learning_style: wizardData.style,
Â  Â  Â  Â  Â  Â  help_needed: wizardData.notes || 'Teacher-created session',
Â  Â  Â  Â  Â  Â  session_date: wizardData.date,
Â  Â  Â  Â  Â  Â  session_time: wizardData.time,
F Â  Â  Â  Â  Â  session_timezone: wizardData.timezone,
Â  Â  Â  Â  Â  Â  session_utc: utcTimestamp,
Â  Â  Â  Â  Â  Â  status: 'scheduled',
Â  Â  Â  Â  Â  Â  age_group: student?.age_group || 'N/A',
Â  Â  Â  Â  Â  Â  instructor_name: document.getElementById('teacherName').textContent
Â  Â  Â  Â  Â  });

Â  Â  Â  Â  if (error) throw new Error(error.message);

Â  Â  Â  Â  closeSessionWizard();
Â  t Â  Â  Â  await loadSessions();
Â  Â  Â  Â  await loadStats();
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  alert('âŒ Error: ' + error.message);
Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  btn.textContent = 'Create Session';
Â  Â  Â  }
Â  Â  }

Â  Â  // TIMEZONE CONVERSION HELPERS
Â  Â  function convertToUTC(localDateTimeString, timezone) {
Â  Â  Â  try {
Â  Â  Â  Â  // 1. Parse the local date/time string manually
Â  Â  Â  Â  // e.g., localDateTimeString = "2025-11-06T09:00"
Â  Â  Â  Â  const [datePart, timePart] = localDateTimeString.split('T');
Â  s Â  Â  const [year, month, day] = datePart.split('-').map(Number);
Â  Â  Â  Â  const [hour, minute] = timePart.split(':').map(Number);

Â  Â  Â  Â  // 2. Create a date object *as if these components were UTC*.
Â  Â  Â  Â  // This gives us a "base" timestamp: 2025-11-06 at 09:00:00 UTC
Â  Â  Â  Â  const baseUtcDate = new Date(Date.UTC(year, month - 1, day, hour, minute));

Â  Â  Â  Â  // 3. Get the string representation of this base date *in the target timezone*.
s Â  Â  Â  // e.g., If base is 09:00 UTC and timezone is 'America/Los_Angeles' (UTC-8),
Â  Â  Â  Â  // this will format to "2025-11-06, 01:00:00".
Â  Â  Â  Â  const options = {
Â  Â  Â  Â  Â  timeZone: timezone,
Â  Â  Â  Â  Â  year: 'numeric', month: '2-digit', day: '2-digit',
NET-8, 0, 8, 11
Â  Â  Â  Â  Â  hour: '2-digit', minute: '2-digit', second: '2-digit',
Â  Â  Â  Â  Â  hour12: false
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Use 'en-CA' (YYYY-MM-DD) or 'sv-SE' for easy, reliable parsing
s Â  Â  Â  const formatter = new Intl.DateTimeFormat('en-CA', options);
Â  Â  Â  Â  const dateInTargetTZ = formatter.format(baseUtcDate); // e.g., "2025-11-06, 01:00:00"

Â  Â  Â  Â  // 4. Parse the parts from the formatted string.
Â  Â  Â  Â  const [tzDatePart, tzTimePart] = dateInTargetTZ.split(', ');
i Â  Â  Â  const [tzYear, tzMonth, tzDay] = tzDatePart.split('-').map(Number);
Â  Â  Â  Â  const [tzHour, tzMinute] = tzTimePart.split(':').slice(0, 2).map(Number);

Â  Â  Â  Â  // 5. Create a new UTC date from these *target timezone parts*.
Â  Â  Â  Â  // This represents 2025-11-06 at 01:00:00 UTC
Â  Â  Â  Â  const localDateInTz_AsUtc = new Date(Date.UTC(tzYear, tzMonth - 1, tzDay, tzHour, tzMinute));
Â  Â  Â  Â Â 
s Â  FÂ 
Â  Â  Â  Â  // 6. Calculate the offset.
Â  Â  Â  Â  // (09:00 UTC) - (01:00 UTC) = 8 hours
s Â  Â  Â  const offset = baseUtcDate.getTime() - localDateInTz_AsUtc.getTime();
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 7. Add the offset to the base UTC date to get the true UTC time.
Â  Â  Â  Â  // (09:00 UTC) + (8 hours) = 17:00 UTC
Â  Â  Â  _B, B, B, 1
Â  Â  Â  Â  const finalUtcDate = new Date(baseUtcDate.getTime() + offset);
Â  Â  Â  Â Â 
Â  Â  Â  Â  return finalUtcDate.toISOString();

Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('âŒ Timezone conversion error:', error);
NET-8, 1, 8, 11
Â  Â  Â  Â  // Fallback to assuming the local string is UTC, which is safer than local time
Â  Â  Â  Â  return new Date(localDateTimeString + 'Z').toISOString();
Â  Â  Â  }
Â  Â  }

Â  Â  // BLACKBOARD FUNCTIONALITY
Â  Â  async function openBlackboard(bookingId) {
Â  Â  Â  const timestamp = Date.now().toString(36);
Â  Â  Â  const random = Math.random().toString(36).substring(2, 8);
Â  Â  Â  const blackboardRoomId = `stem-${timestamp}-${random}`;
Â  Â  Â  const encryptionKey = generateRandomKey();
Â  Â  Â  const blackboardLink = `https://excalidraw.com/#room=${blackboardRoomId},${encryptionKey}`;
Â  Â  Â Â 
Â  Â  Â  const { error } = await supabaseClient.from('bookings').update({ whiteboard_link: blackboardLink }).eq('id', bookingId);
Â  Â  Â Â 
Â  Â  Â  if (error) {
Â  Â  Â  Â  alert('Error saving blackboard link. Check console.');
Â  Â  Â  Â  return;
Â  s Â  Â  }
Â  Â  Â Â 
Â  Â  Â  window.open(blackboardLink, '_blank');
Â  Â  Â  await loadSessions();
Â  Â  }
Â  Â Â 
Â  Â  function generateRandomKey() {
Â  Â  Â  const array = new Uint8Array(16);
Â  Â  Â  crypto.getRandomValues(array);
Â  Â  Â  const key = Array.from(array).map(b => b.toString(36)).join('').substring(0, 22);
Â  Â  Â  return key.padEnd(22, Math.random().toString(36).substring(2));
Â  Â  }

Â  Â  // Initialize on page load
Â  Â  checkTeacherAuth();
Â  </script>
</body>
</html>
